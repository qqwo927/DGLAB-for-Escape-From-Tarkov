<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘å¡é€‰æ‹©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
        }
        
        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        
        select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background-color: #fff;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }
        
        select:hover {
            border-color: #667eea;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .selected-info {
            margin-top: 20px;
            padding: 16px;
            background: #f5f7fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .selected-info h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .selected-info p {
            color: #666;
            font-size: 13px;
            margin: 4px 0;
        }
        
        .selected-info strong {
            color: #667eea;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
            font-size: 14px;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
        
        .refresh-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        
        .refresh-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .refresh-btn:active {
            transform: translateY(0);
        }
        
        .start-btn {
            width: 100%;
            padding: 12px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        
        .start-btn:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .start-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .start-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .status-info {
            margin-top: 20px;
            padding: 16px;
            background: #f0fdf4;
            border-radius: 8px;
            border-left: 4px solid #10b981;
            display: none;
        }
        
        .status-info.error {
            background: #fef2f2;
            border-left-color: #ef4444;
        }
        
        .status-info h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .status-info p {
            color: #666;
            font-size: 13px;
            margin: 4px 0;
        }
        
        .qrcode-container {
            margin-top: 20px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            text-align: center;
            display: none;
        }
        
        .qrcode-container h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .qrcode-container img {
            max-width: 100%;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        
        .qrcode-url {
            margin-top: 15px;
            padding: 10px;
            background: #f5f7fa;
            border-radius: 6px;
            font-size: 12px;
            color: #666;
            word-break: break-all;
        }
        
        .game-status-container {
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #10b981;
            display: none;
        }
        
        .game-status-container h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .status-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-item-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .status-item-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .status-item-value.status-game {
            color: #10b981;
        }
        
        .status-item-value.status-bag {
            color: #f59e0b;
        }
        
        .status-item-value.status-other {
            color: #ef4444;
        }
        
        .status-item-value.power {
            color: #667eea;
        }
        
        .status-item-value.hp {
            color: #ec4899;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            padding: 20px;
            font-size: 14px;
        }
        
        .config-container {
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: none;
        }
        
        .config-container h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .config-section {
            margin-bottom: 25px;
        }
        
        .config-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .config-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .config-item {
            display: flex;
            flex-direction: column;
        }
        
        .config-item.full-width {
            grid-column: 1 / -1;
        }
        
        .config-item label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .config-item input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .config-item input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .config-item input[type="number"] {
            -moz-appearance: textfield;
        }
        
        .config-item input[type="number"]::-webkit-outer-spin-button,
        .config-item input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .config-save-btn {
            width: 100%;
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .config-save-btn:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .config-save-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .config-toggle-btn {
            background: transparent;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .config-toggle-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .save-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
            display: none;
        }
        
        .save-status.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .save-status.error {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ ç½‘å¡é€‰æ‹©</h1>
        <p class="subtitle">è¯·é€‰æ‹©è¦ä½¿ç”¨çš„ç½‘ç»œæ¥å£</p>
        
        <div class="form-group">
            <label for="networkSelect">ç½‘ç»œæ¥å£ï¼š</label>
            <select id="networkSelect">
                <option value="">åŠ è½½ä¸­...</option>
            </select>
            <div class="error" id="errorMsg"></div>
        </div>
        
        <div class="selected-info" id="selectedInfo" style="display: none;">
            <h3>å·²é€‰æ‹©ï¼š</h3>
            <p><strong>æ¥å£åç§°ï¼š</strong><span id="ifaceName">-</span></p>
            <p><strong>IP åœ°å€ï¼š</strong><span id="ipAddress">-</span></p>
        </div>
        
        <button class="start-btn" id="startBtn" onclick="startServer()" disabled>ğŸš€ å¯åŠ¨ DGLab æœåŠ¡å™¨</button>
        
        <div class="status-info" id="statusInfo">
            <h3 id="statusTitle">çŠ¶æ€</h3>
            <p id="statusMessage"></p>
        </div>
        
        <div class="qrcode-container" id="qrcodeContainer">
            <h3>ğŸ“± æ‰«æäºŒç»´ç è¿æ¥</h3>
            <p style="color: #666; font-size: 13px; margin-bottom: 15px;">è¯·ç”¨DG-Lab App,é€‰æ‹©Socketæ§åˆ¶ æ‰«æä¸‹æ–¹äºŒç»´ç  ä»¥ ç»‘å®šè¿æ¥</p>
            <img id="qrcodeImage" src="" alt="äºŒç»´ç ">
            <div class="qrcode-url" id="qrcodeUrl"></div>
        </div>
        
        <div class="game-status-container" id="gameStatusContainer">
            <h3>ğŸ® æ¸¸æˆçŠ¶æ€</h3>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-item-label">å½“å‰çŠ¶æ€</div>
                    <div class="status-item-value" id="statusValue">-</div>
                </div>
                <div class="status-item">
                    <div class="status-item-label">è¾“å‡ºå¼ºåº¦</div>
                    <div class="status-item-value power" id="powerValue">0</div>
                </div>
                <div class="status-item">
                    <div class="status-item-label">HPå€¼</div>
                    <div class="status-item-value hp" id="hpValue">0</div>
                </div>
            </div>
        </div>
        
        <div class="config-container" id="configContainer">
            <h3>
                âš™ï¸ å®æ—¶é…ç½®
                <button class="config-toggle-btn" onclick="toggleConfig()">æ”¶èµ·</button>
            </h3>
            
            <div class="config-section">
                <div class="config-section-title">åŸºç¡€è®¾ç½®</div>
                <div class="config-row">
                    <div class="config-item">
                        <label>å¼ºåº¦ä¸Šé™ (PowerLimit)</label>
                        <input type="number" id="configPowerLimit" step="1" min="0" max="200">
                    </div>
                    <div class="config-item">
                        <label>è¯†åˆ«é¢‘ç‡ (Ratelimit)</label>
                        <input type="number" id="configRatelimit" step="0.1" min="0.1" max="5">
                    </div>
                </div>
                <div class="config-row">
                    <div class="config-item">
                        <label>HPä½é˜ˆå€¼ (HPlow)</label>
                        <input type="number" id="configHPlow" step="1" min="0" max="500">
                    </div>
                    <div class="config-item">
                        <label>HPé«˜é˜ˆå€¼ (HPhigh)</label>
                        <input type="number" id="configHPhigh" step="1" min="0" max="500">
                    </div>
                </div>
            </div>
            
            <div class="config-section">
                <div class="config-section-title">æ³¢å½¢è®¾ç½®</div>
                <div class="config-item full-width">
                    <label>é€‰æ‹©æ³¢å½¢</label>
                    <select id="configWaveSelect">
                        <option value="custom">custom (è‡ªå®šä¹‰)</option>
                    </select>
                </div>
            </div>
            
            <div class="config-section">
                <div class="config-section-title">èƒŒåŒ…é¢œè‰²è¯†åˆ«</div>
                <div class="config-row">
                    <div class="config-item">
                        <label>èƒŒåŒ…é¢œè‰²æœ€å°å€¼ (R)</label>
                        <input type="number" id="configBagColorMinR" step="1" min="0" max="255">
                    </div>
                    <div class="config-item">
                        <label>èƒŒåŒ…é¢œè‰²æœ€å°å€¼ (G)</label>
                        <input type="number" id="configBagColorMinG" step="1" min="0" max="255">
                    </div>
                </div>
                <div class="config-row">
                    <div class="config-item">
                        <label>èƒŒåŒ…é¢œè‰²æœ€å°å€¼ (B)</label>
                        <input type="number" id="configBagColorMinB" step="1" min="0" max="255">
                    </div>
                    <div class="config-item">
                        <label>èƒŒåŒ…é¢œè‰²æœ€å¤§å€¼ (R)</label>
                        <input type="number" id="configBagColorMaxR" step="1" min="0" max="255">
                    </div>
                </div>
                <div class="config-row">
                    <div class="config-item">
                        <label>èƒŒåŒ…é¢œè‰²æœ€å¤§å€¼ (G)</label>
                        <input type="number" id="configBagColorMaxG" step="1" min="0" max="255">
                    </div>
                    <div class="config-item">
                        <label>èƒŒåŒ…é¢œè‰²æœ€å¤§å€¼ (B)</label>
                        <input type="number" id="configBagColorMaxB" step="1" min="0" max="255">
                    </div>
                </div>
            </div>
            
            <div class="config-section">
                <div class="config-section-title">è§’è‰²HSVè¯†åˆ« - æœ€å¤§å€¼</div>
                <div class="config-row">
                    <div class="config-item">
                        <label>Hæœ€å¤§å€¼ (RoleHmax)</label>
                        <input type="number" id="configRoleHmax" step="1" min="0" max="360">
                    </div>
                    <div class="config-item">
                        <label>Sæœ€å¤§å€¼ (RoleSmax)</label>
                        <input type="number" id="configRoleSmax" step="0.1" min="0" max="1">
                    </div>
                </div>
                <div class="config-row">
                    <div class="config-item">
                        <label>Væœ€å¤§å€¼ (RoleVMax)</label>
                        <input type="number" id="configRoleVMax" step="0.1" min="0" max="1">
                    </div>
                </div>
            </div>
            
            <div class="config-section">
                <div class="config-section-title">è§’è‰²HSVè¯†åˆ« - æœ€å°å€¼</div>
                <div class="config-row">
                    <div class="config-item">
                        <label>Hæœ€å°å€¼ (RoleHmin)</label>
                        <input type="number" id="configRoleHmin" step="1" min="0" max="360">
                    </div>
                    <div class="config-item">
                        <label>Sæœ€å°å€¼ (RoleSmin)</label>
                        <input type="number" id="configRoleSmin" step="0.1" min="0" max="1">
                    </div>
                </div>
                <div class="config-row">
                    <div class="config-item">
                        <label>Væœ€å°å€¼ (RoleVMin)</label>
                        <input type="number" id="configRoleVMin" step="0.1" min="0" max="1">
                    </div>
                    <div class="config-item">
                        <label>æ¸©åº¦ç¼“å†²ç‡ (tempRate)</label>
                        <input type="number" id="configTempRate" step="0.1" min="0" max="1">
                    </div>
                </div>
            </div>
            
            <button class="config-save-btn" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
            <div class="save-status" id="saveStatus"></div>
        </div>
        
        <button class="refresh-btn" onclick="loadNetworks()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
        <button class="refresh-btn" onclick="toggleConfig()" style="margin-top: 10px;">âš™ï¸ é…ç½®ç®¡ç†</button>
    </div>
    
    <script>
        let networks = [];
        
        async function loadNetworks() {
            const select = document.getElementById('networkSelect');
            const errorMsg = document.getElementById('errorMsg');
            const selectedInfo = document.getElementById('selectedInfo');
            
            // é‡ç½®çŠ¶æ€
            errorMsg.style.display = 'none';
            selectedInfo.style.display = 'none';
            select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
            select.disabled = true;
            
            try {
                const response = await fetch('/networks');
                if (!response.ok) {
                    throw new Error('è·å–ç½‘ç»œåˆ—è¡¨å¤±è´¥');
                }
                
                networks = await response.json();
                
                if (networks.length === 0) {
                    select.innerHTML = '<option value="">æœªæ‰¾åˆ°å¯ç”¨ç½‘ç»œæ¥å£</option>';
                    return;
                }
                
                // æ¸…ç©ºå¹¶å¡«å……é€‰é¡¹
                select.innerHTML = '<option value="">è¯·é€‰æ‹©ç½‘ç»œæ¥å£</option>';
                networks.forEach((network, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${network.iface_name} (${network.ip_str})`;
                    select.appendChild(option);
                });
                
                select.disabled = false;
            } catch (error) {
                errorMsg.textContent = 'é”™è¯¯ï¼š' + error.message;
                errorMsg.style.display = 'block';
                select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            }
        }
        
        function updateSelectedInfo() {
            const select = document.getElementById('networkSelect');
            const selectedInfo = document.getElementById('selectedInfo');
            const ifaceName = document.getElementById('ifaceName');
            const ipAddress = document.getElementById('ipAddress');
            const startBtn = document.getElementById('startBtn');
            
            const selectedIndex = select.value;
            
            if (selectedIndex === '' || !networks[selectedIndex]) {
                selectedInfo.style.display = 'none';
                startBtn.disabled = true;
                return;
            }
            
            const selected = networks[selectedIndex];
            ifaceName.textContent = selected.iface_name;
            ipAddress.textContent = selected.ip_str;
            selectedInfo.style.display = 'block';
            startBtn.disabled = false;
        }
        
        async function startServer() {
            const select = document.getElementById('networkSelect');
            const startBtn = document.getElementById('startBtn');
            const statusInfo = document.getElementById('statusInfo');
            const statusTitle = document.getElementById('statusTitle');
            const statusMessage = document.getElementById('statusMessage');
            
            const selectedIndex = select.value;
            
            if (selectedIndex === '' || !networks[selectedIndex]) {
                statusInfo.className = 'status-info error';
                statusTitle.textContent = 'é”™è¯¯';
                statusMessage.textContent = 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç½‘ç»œæ¥å£';
                statusInfo.style.display = 'block';
                return;
            }
            
            const selected = networks[selectedIndex];
            const ipAddress = selected.ip_str;
            
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            startBtn.disabled = true;
            startBtn.textContent = 'å¯åŠ¨ä¸­...';
            statusInfo.style.display = 'none';
            
            try {
                const response = await fetch('/dglab/start-with-ip', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ip_address: ipAddress
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'started') {
                    statusInfo.className = 'status-info';
                    statusTitle.textContent = 'âœ… å¯åŠ¨æˆåŠŸ';
                    statusMessage.textContent = result.message;
                    statusInfo.style.display = 'block';
                    startBtn.textContent = 'ğŸš€ å¯åŠ¨ DGLab æœåŠ¡å™¨';
                    
                    // æ˜¾ç¤ºäºŒç»´ç 
                    if (result.qrcode_data) {
                        const qrcodeContainer = document.getElementById('qrcodeContainer');
                        const qrcodeImage = document.getElementById('qrcodeImage');
                        const qrcodeUrl = document.getElementById('qrcodeUrl');
                        
                        qrcodeImage.src = result.qrcode_data;
                        if (result.qrcode_url) {
                            qrcodeUrl.textContent = 'è¿æ¥åœ°å€: ' + result.qrcode_url;
                        }
                        qrcodeContainer.style.display = 'block';
                    }
                    
                    // å¼€å§‹è½®è¯¢æ¸¸æˆçŠ¶æ€
                    startStatusPolling();
                    
                    // å¦‚æœé…ç½®ç•Œé¢å·²å±•å¼€ï¼Œé‡æ–°åŠ è½½é…ç½®
                    if (configExpanded) {
                        loadConfig();
                    }
                } else if (result.status === 'already_running') {
                    statusInfo.className = 'status-info error';
                    statusTitle.textContent = 'âš ï¸ æç¤º';
                    statusMessage.textContent = result.message;
                    statusInfo.style.display = 'block';
                    startBtn.textContent = 'ğŸš€ å¯åŠ¨ DGLab æœåŠ¡å™¨';
                    startBtn.disabled = false;
                } else {
                    statusInfo.className = 'status-info error';
                    statusTitle.textContent = 'âŒ å¯åŠ¨å¤±è´¥';
                    statusMessage.textContent = result.message;
                    statusInfo.style.display = 'block';
                    startBtn.textContent = 'ğŸš€ å¯åŠ¨ DGLab æœåŠ¡å™¨';
                    startBtn.disabled = false;
                }
            } catch (error) {
                statusInfo.className = 'status-info error';
                statusTitle.textContent = 'âŒ é”™è¯¯';
                statusMessage.textContent = 'å¯åŠ¨å¤±è´¥: ' + error.message;
                statusInfo.style.display = 'block';
                startBtn.textContent = 'ğŸš€ å¯åŠ¨ DGLab æœåŠ¡å™¨';
                startBtn.disabled = false;
            }
        }
        
        let statusPollInterval = null;
        
        async function updateGameStatus() {
            try {
                const response = await fetch('/dglab/game-status');
                if (!response.ok) {
                    return;
                }
                
                const data = await response.json();
                const statusContainer = document.getElementById('gameStatusContainer');
                const statusValue = document.getElementById('statusValue');
                const powerValue = document.getElementById('powerValue');
                const hpValue = document.getElementById('hpValue');
                const qrcodeContainer = document.getElementById('qrcodeContainer');
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                statusValue.textContent = data.status || 'æœªå¯åŠ¨';
                powerValue.textContent = data.power || 0;
                hpValue.textContent = Math.round(data.hp || 0);
                
                // æ ¹æ®çŠ¶æ€è®¾ç½®é¢œè‰²
                statusValue.className = 'status-item-value';
                if (data.status === 'æ¸¸æˆä¸­') {
                    statusValue.classList.add('status-game');
                } else if (data.status === 'åœ¨èƒŒåŒ…') {
                    statusValue.classList.add('status-bag');
                } else if (data.status === 'æœªè¿›å…¥æ¸¸æˆ' || data.status === 'æœªå¯åŠ¨') {
                    statusValue.classList.add('status-other');
                }
                
                // å¦‚æœæœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œæ˜¾ç¤ºçŠ¶æ€å®¹å™¨
                if (data.status && data.status !== 'æœªå¯åŠ¨') {
                    statusContainer.style.display = 'block';
                }
                
                // æ ¹æ®è¿æ¥çŠ¶æ€å’Œæ¸¸æˆçŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤ºäºŒç»´ç 
                // å¦‚æœå·²è¿æ¥ æˆ– game_status ä¸ç­‰äº"æœªå¯åŠ¨"ï¼Œåˆ™éšè—äºŒç»´ç 
                if (data.is_connected || (data.status && data.status !== 'æœªå¯åŠ¨')) {
                    qrcodeContainer.style.display = 'none';
                } else {
                    // åªæœ‰åœ¨æœªè¿æ¥ä¸”çŠ¶æ€ä¸º"æœªå¯åŠ¨"æ—¶æ‰æ˜¾ç¤ºäºŒç»´ç ï¼ˆå¦‚æœäºŒç»´ç æ•°æ®å­˜åœ¨ï¼‰
                    const qrcodeImage = document.getElementById('qrcodeImage');
                    if (qrcodeImage && qrcodeImage.src) {
                        qrcodeContainer.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('è·å–æ¸¸æˆçŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        function startStatusPolling() {
            // å¦‚æœå·²ç»æœ‰è½®è¯¢åœ¨è¿è¡Œï¼Œå…ˆæ¸…é™¤
            if (statusPollInterval) {
                clearInterval(statusPollInterval);
            }
            
            // ç«‹å³æ›´æ–°ä¸€æ¬¡
            updateGameStatus();
            
            // æ¯500msè½®è¯¢ä¸€æ¬¡
            statusPollInterval = setInterval(updateGameStatus, 500);
        }
        
        function stopStatusPolling() {
            if (statusPollInterval) {
                clearInterval(statusPollInterval);
                statusPollInterval = null;
            }
        }
        
        // é…ç½®ç®¡ç†ç›¸å…³å‡½æ•°
        let configExpanded = false;
        
        function toggleConfig() {
            const configContainer = document.getElementById('configContainer');
            const toggleBtn = configContainer.querySelector('.config-toggle-btn');
            
            if (configExpanded) {
                configContainer.style.display = 'none';
                if (toggleBtn) toggleBtn.textContent = 'å±•å¼€';
            } else {
                configContainer.style.display = 'block';
                if (toggleBtn) toggleBtn.textContent = 'æ”¶èµ·';
                loadConfig();
            }
            configExpanded = !configExpanded;
        }
        
        async function loadWaves() {
            try {
                const response = await fetch('/dglab/waves');
                if (!response.ok) return;
                const waves = await response.json();
                const select = document.getElementById('configWaveSelect');
                
                // ä¿ç•™ custom é€‰é¡¹ï¼Œæ·»åŠ å…¶ä»–
                select.innerHTML = '<option value="custom">custom (è‡ªå®šä¹‰)</option>';
                
                waves.forEach(wave => {
                    if (wave !== 'custom') {
                        const option = document.createElement('option');
                        option.value = wave;
                        option.textContent = wave;
                        select.appendChild(option);
                    }
                });
            } catch (e) {
                console.error("åŠ è½½æ³¢å½¢åˆ—è¡¨å¤±è´¥", e);
            }
        }

        async function loadConfig() {
            try {
                // å…ˆåŠ è½½æ³¢å½¢åˆ—è¡¨
                await loadWaves();

                const response = await fetch('/dglab/config');
                if (!response.ok) {
                    throw new Error('è·å–é…ç½®å¤±è´¥');
                }
                
                const config = await response.json();
                
                // å¡«å……åŸºç¡€é…ç½®
                document.getElementById('configPowerLimit').value = config.PowerLimit || 60;
                document.getElementById('configRatelimit').value = config.Ratelimit || 0.4;
                document.getElementById('configHPlow').value = config.HPlow || 100;
                document.getElementById('configHPhigh').value = config.HPhigh || 435;
                
                // å¡«å……æ³¢å½¢é€‰æ‹©
                const waveSelect = document.getElementById('configWaveSelect');
                if (config.WaveName) {
                    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯¥é€‰é¡¹ï¼Œå¦‚æœä¸å­˜åœ¨ï¼ˆå¯èƒ½æ˜¯æ‰‹åŠ¨æ”¹çš„ï¼‰ï¼Œé»˜è®¤é€‰ custom
                    let exists = false;
                    for(let i=0; i<waveSelect.options.length; i++) {
                        if (waveSelect.options[i].value === config.WaveName) {
                            exists = true;
                            break;
                        }
                    }
                    waveSelect.value = exists ? config.WaveName : 'custom';
                }

                // å¡«å……èƒŒåŒ…é¢œè‰²é…ç½®
                if (config.BagColorMin && config.BagColorMin.length >= 3) {
                    document.getElementById('configBagColorMinR').value = config.BagColorMin[0];
                    document.getElementById('configBagColorMinG').value = config.BagColorMin[1];
                    document.getElementById('configBagColorMinB').value = config.BagColorMin[2];
                }
                if (config.BagColorMax && config.BagColorMax.length >= 3) {
                    document.getElementById('configBagColorMaxR').value = config.BagColorMax[0];
                    document.getElementById('configBagColorMaxG').value = config.BagColorMax[1];
                    document.getElementById('configBagColorMaxB').value = config.BagColorMax[2];
                }
                
                // å¡«å……è§’è‰²HSVæœ€å¤§å€¼é…ç½®
                document.getElementById('configRoleHmax').value = config.RoleHmax || 130;
                document.getElementById('configRoleSmax').value = config.RoleSmax || 1;
                document.getElementById('configRoleVMax').value = config.RoleVMax || 0.6;
                
                // å¡«å……è§’è‰²HSVæœ€å°å€¼é…ç½®
                document.getElementById('configRoleHmin').value = config.RoleHmin || 0;
                document.getElementById('configRoleSmin').value = config.RoleSmin || 0.4;
                document.getElementById('configRoleVMin').value = config.RoleVMin || 0.1;
                
                // å¡«å……æ¸©åº¦ç¼“å†²ç‡
                document.getElementById('configTempRate').value = config.tempRate || 0.3;
                
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                showSaveStatus('åŠ è½½é…ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function saveConfig() {
            const saveBtn = document.querySelector('.config-save-btn');
            const saveStatus = document.getElementById('saveStatus');
            
            // ç¦ç”¨æŒ‰é’®
            saveBtn.disabled = true;
            saveBtn.textContent = 'ä¿å­˜ä¸­...';
            saveStatus.style.display = 'none';
            
            try {
                // æ”¶é›†é…ç½®æ•°æ®
                const configData = {
                    PowerLimit: parseFloat(document.getElementById('configPowerLimit').value),
                    Ratelimit: parseFloat(document.getElementById('configRatelimit').value),
                    HPlow: parseFloat(document.getElementById('configHPlow').value),
                    HPhigh: parseFloat(document.getElementById('configHPhigh').value),
                    WaveName: document.getElementById('configWaveSelect').value,
                    BagColorMin: [
                        parseInt(document.getElementById('configBagColorMinR').value),
                        parseInt(document.getElementById('configBagColorMinG').value),
                        parseInt(document.getElementById('configBagColorMinB').value)
                    ],
                    BagColorMax: [
                        parseInt(document.getElementById('configBagColorMaxR').value),
                        parseInt(document.getElementById('configBagColorMaxG').value),
                        parseInt(document.getElementById('configBagColorMaxB').value)
                    ],
                    RoleHmax: parseFloat(document.getElementById('configRoleHmax').value),
                    RoleSmax: parseFloat(document.getElementById('configRoleSmax').value),
                    RoleVMax: parseFloat(document.getElementById('configRoleVMax').value),
                    RoleHmin: parseFloat(document.getElementById('configRoleHmin').value),
                    RoleSmin: parseFloat(document.getElementById('configRoleSmin').value),
                    RoleVMin: parseFloat(document.getElementById('configRoleVMin').value),
                    tempRate: parseFloat(document.getElementById('configTempRate').value)
                };
                
                // å‘é€æ›´æ–°è¯·æ±‚
                const response = await fetch('/dglab/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(configData)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showSaveStatus('âœ… é…ç½®å·²ä¿å­˜å¹¶å®æ—¶ç”Ÿæ•ˆ', 'success');
                } else {
                    showSaveStatus('âŒ ä¿å­˜å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                showSaveStatus('âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®
                saveBtn.disabled = false;
                saveBtn.textContent = 'ğŸ’¾ ä¿å­˜é…ç½®';
            }
        }
        
        function showSaveStatus(message, type) {
            const saveStatus = document.getElementById('saveStatus');
            saveStatus.textContent = message;
            saveStatus.className = 'save-status ' + type;
            saveStatus.style.display = 'block';
            
            // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
                setTimeout(() => {
                    saveStatus.style.display = 'none';
                }, 3000);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–ç½‘ç»œåˆ—è¡¨
        document.addEventListener('DOMContentLoaded', loadNetworks);
        
        // ç›‘å¬é€‰æ‹©å˜åŒ–
        document.getElementById('networkSelect').addEventListener('change', updateSelectedInfo);
    </script>
</body>
</html>
